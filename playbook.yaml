---
- hosts: "{{ group }}"
  become: true

  tasks:

  - name: Update apt repo and cache on all Debian/Ubuntu boxes
    apt:
     update_cache: yes
     force_apt_get: yes
     cache_valid_time: 3600
  
  - name: install unzip
    become: true
    shell:apt install unzip
  

  #  - name: Transfer file from agentServer to hosting servers
  #    synchronize:
  #      src: /home/azureuser/myagent/_work/1/a/app-artifact/bootcamp.zip
  #      dest: /home/azureuser/
  - name: Transfer folder from agentServer to hosting servers
    synchronize:
      src: /home/adminuser/myagent/_work/1/a/bootcamp.zip
      dest: /home/adminuser/bootcamp-app
  - name: Unarchive a file that is already on the remote machine
    unarchive:
      src: /home/azureuser/bootcamp.zip
      dest: /home/azureuser/
      remote_src: yes

  

  - name: Transfer file from agentServer to hosting servers
    synchronize:
      src: /home/adminuser/myagent/_work/1/s/.env
      dest: /home/adminuser/bootcamp-app
  - name: Database initialization
    shell: npm run initdb
    async: 30
    poll: 0
    args:
      chdir: "/home/adminuser/bootcamp-app"

  - name: Install pm2
    shell: npm install pm2@latest -g

  - name: Run application
    shell: pm2 start npm -- run dev && pm2 save && pm2 startup
    args:
      chdir: "/home/adminuser/bootcamp-app"